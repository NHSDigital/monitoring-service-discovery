name: "$(SourceBranchName)+$(BuildID)"

# Prevents building every commit or on PR
trigger: none
pr: none

# Consume an artifact from the build pipeline as soon as it becomes available.
resources:
  pipelines:
    - pipeline: monitoring-service-discovery
      source: "Monitoring-SD-Build"
      trigger:
        branches:
          exclude:
            - 'master'
            - "refs/heads/master"
            - 'refs/tags/v*'
  repositories:
    - repository: templates
      type: github
      name: NHSDigital/api-management-utils
      ref: refs/heads/edge
      endpoint: NHSDigital

# env variables
variables:
  SERVICE_NAME: monitoring-service-discovery
  SERVICE_BASE_PATH: /monitoring-sd
  PRODUCT_DISPLAY_NAME: Monitoring Service Discovery
  PRODUCT_DESCRIPTION: A service discovery for populating blackbox-exporter endpoints
  AWS_ENV: ptl
  FORCE_SANDBOX: false
  NAMESPACE: from_branchname
  PROXY_NAME: live

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: DeployInternalDev
    displayName: internal-dev
    variables:
    - group: apigee-nonprod
    - group: env-internal-dev
    jobs:
      - deployment: DeployService
        displayName: Deploy Service
        environment: 'internal-dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: az/templates/pre-tasks.yml@templates
                - template: az/templates/setup-build-name.yml@templates
                - template: az/templates/deploy-namespaced-service.yml@templates
